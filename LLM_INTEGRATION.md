# LLM 消息分析集成指南

本文档说明了如何在网球聊天系统中配置和使用基于LLM的消息分析功能。

## 功能概述

系统现在支持使用大型语言模型（LLM）对用户消息进行深度分析，基于**网球场理论**判断消息是否"越网"，从而进行精确的计分。

### 网球场理论核心规则

- **未越网（合规表达）**：用户使用"我"的表达，描述自己的感受、观察，表达需求和边界
- **越网（违规表达）**：用户使用"你"的判断，对他人进行推测、解释或假设

### 计分逻辑

- **越网时**：扣一分（消息过网了，对手得分）
- **没越网时**：加一分（消息撞网，自己得分）

## 环境配置

### 1. 环境变量设置

在 `.env` 文件中添加以下配置：

```env
# LLM Configuration for Message Analysis
OPENAI_API_KEY=sk-your-openai-api-key-here
OPENAI_MODEL=gpt-4o-mini
OPENAI_BASE_URL=https://api.openai.com/v1
```

### 2. 配置说明

- `OPENAI_API_KEY`：OpenAI API 密钥（必需，如果要使用LLM分析）
- `OPENAI_MODEL`：使用的模型（默认：gpt-4o-mini，推荐用于成本优化）
- `OPENAI_BASE_URL`：API 基础URL（可选，用于自定义端点）

### 3. 支持的模型

推荐模型（按成本效益排序）：
- `gpt-4o-mini` - 最推荐，成本低，性能足够
- `gpt-3.5-turbo` - 较低成本，基础性能
- `gpt-4` - 最高性能，成本较高

## 工作流程

### 1. 消息分析流程

1. **获取上下文**：系统获取最近10条消息作为对话历史
2. **LLM分析**：使用专业的网球场理论提示词进行分析
3. **结果解析**：解析LLM返回的JSON格式分析结果
4. **分数计算**：根据是否越网进行计分
5. **存储结果**：将分析结果保存到数据库

### 2. 降级处理

如果LLM不可用，系统会自动降级到简单的关键词分析：

```javascript
// 积极模式（未越网）
["我感到", "我觉得", "我观察到", "我希望", "我需要", "我认为"]

// 消极模式（越网）
["你总是", "你从不", "你就是", "你应该", "你必须"]
```

## 分析结果格式

LLM返回的分析结果包含以下字段：

```json
{
  "isCrossNet": "是" | "否",
  "senderState": "发送者的需求、动机、意图和背景分析",
  "receiverImpact": "对接收者的预期影响、感受和反应",
  "evidence": "具体的越网证据或未越网的证明",
  "suggestion": "具体的改进建议",
  "risk": "高" | "中" | "低"
}
```

## 系统架构

### 核心文件

- `src/lib/llm/client.ts` - LLM客户端和分析逻辑
- `src/app/api/room/[id]/message/route.ts` - 消息处理和分析集成
- `src/config/server.ts` - 环境变量验证

### 数据流

```
用户消息 → 获取历史对话 → LLM分析 → 结果解析 → 计分 → 存储
```

## 成本控制

### 1. 模型选择

- 开发环境：使用 `gpt-4o-mini`
- 生产环境：根据准确性需求选择合适模型

### 2. 请求优化

- 历史对话限制为最近10条
- 使用较低的 temperature (0.1) 确保一致性
- 限制 max_tokens 为 1000

### 3. 监控建议

建议监控以下指标：
- API调用次数和成本
- 分析准确性
- 降级处理频率

## 开发和测试

### 1. 本地开发

无需配置真实API密钥，系统会自动使用降级分析。

### 2. 测试消息示例

**越网消息示例**：
- "你总是这样逃避问题"
- "你就是不想承担责任"

**未越网消息示例**：
- "我感到很困扰"
- "我观察到这个问题已经讨论了几次"
- "我希望能找到解决方案"

### 3. 调试

检查控制台日志以查看：
- LLM分析请求和响应
- 降级分析触发情况
- 分析错误和异常

## 安全考虑

1. **API密钥安全**：
   - 不要在客户端暴露API密钥
   - 使用环境变量存储敏感信息
   - 定期轮换API密钥

2. **内容过滤**：
   - 系统专注于沟通模式分析
   - 不存储敏感的个人信息
   - 遵循数据隐私最佳实践

3. **错误处理**：
   - 优雅降级到简单分析
   - 不暴露内部错误信息
   - 记录异常但保护用户隐私

## 故障排除

### 常见问题

1. **分析不工作**：检查 `OPENAI_API_KEY` 是否正确配置
2. **分数不变**：检查消息是否触发了分析逻辑
3. **性能慢**：考虑使用更快的模型或减少上下文长度

### 日志检查

查看应用日志中的以下信息：
- "Message analysis failed" - 分析失败
- "Error analyzing message with LLM" - LLM调用错误
- "Fallback analysis" - 降级分析触发

## 未来改进

1. **缓存机制**：为相似消息实现缓存
2. **批量分析**：支持批量处理多条消息
3. **个性化**：基于用户历史调整分析参数
4. **多语言支持**：扩展到其他语言的分析
5. **实时反馈**：提供实时的沟通建议

---

通过这个集成，网球聊天系统现在能够提供基于专业理论的深度消息分析，帮助用户改进沟通质量。